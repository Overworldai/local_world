/* ============================================
   VIDEO MASK - Portal overlay with state machine
   ============================================

   States: cold, warm, hot (controlled via PortalState)

   CSS Custom Properties:
   --mask-size: portal radius in px
   --mask-aspect: width/height ratio (0.8 = tall oval)
   --mask-cy: vertical center position
   --mask-feather: edge softness
   --mask-duration: animation duration
   --ring-width/height: glow ring dimensions
   --pulse-offset: breathing animation offset

   JS API: window.PortalState, window.VideoMask
   ============================================ */

/* ============================================
   CUSTOM PROPERTY REGISTRATION
   ============================================ */

@property --mask-size {
  syntax: '<length>';
  inherits: false;
  initial-value: 0px;
}

@property --pulse-offset {
  syntax: '<length>';
  inherits: false;
  initial-value: 0px;
}

@property --mask-cy {
  syntax: '<percentage>';
  inherits: true;
  initial-value: 50%;
}

@property --ring-width {
  syntax: '<length>';
  inherits: true;
  initial-value: 160px;
}

@property --ring-height {
  syntax: '<length>';
  inherits: true;
  initial-value: 200px;
}

@property --glow-angle {
  syntax: '<angle>';
  inherits: false;
  initial-value: 0deg;
}

/* ============================================
   PORTAL BACKGROUNDS - State visibility
   ============================================ */

/* Permanent base layer that never fades */
.video-container::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #020617;
  z-index: 0;
}

/* All backgrounds always visible - use opacity for transitions */
.portal-background {
  opacity: 1;
  transition: opacity 1s ease-out;
}

/* Cold state transitions */
.portal-background-cold {
  z-index: 10;
}

.portal-background-cold:not(.active) {
  opacity: 0;
  transition: opacity 1.2s ease-in;
}

.portal-background-cold::before,
.portal-background-cold::after {
  transition: opacity 1.2s ease-in, transform 1.2s ease-in;
}

.portal-background-cold:not(.active)::before {
  opacity: 0;
  transform: translate(-50%, -50%) perspective(500px) rotateX(60deg) scale(2);
}

.portal-background-cold:not(.active)::after {
  opacity: 0;
}

/* Warm state transitions */
.portal-background-warm {
  z-index: 20;
  opacity: 0;
  transform: scale(0.9);
}

.portal-background-warm.active {
  opacity: 1;
  transform: scale(1);
  transition: opacity 1s ease-out 0.2s, transform 1s ease-out 0.2s;
}

.portal-background-warm .tunnel-rings,
.portal-background-warm .warp-center,
.portal-background-warm .streak {
  transition: opacity 0.8s ease-out;
}

.portal-background-warm:not(.active) .tunnel-rings,
.portal-background-warm:not(.active) .warp-center,
.portal-background-warm:not(.active) .streak {
  opacity: 0 !important;
}

/* Warm fading out */
.portal-background-warm:not(.active) {
  opacity: 0;
  transform: scale(1.1);
  transition: opacity 0.8s ease-in, transform 0.8s ease-in;
}

/* Hot state transitions */
.portal-background-hot {
  z-index: 30;
  opacity: 0;
}

.portal-background-hot.active {
  opacity: 1;
  transition: opacity 0.5s ease-out;
}

.portal-background-hot::before {
  transition: opacity 0.3s ease-out;
}

.portal-background-hot:not(.active)::before {
  opacity: 0;
}

/* Hide video until connected */
.video-container video {
  position: relative;
  z-index: 40;
  opacity: 0;
  transition: opacity 0.3s ease;
  background: #020617;
}

.video-container.connected video {
  opacity: 1;
}

/* ============================================
   BASE PORTAL STYLES
   ============================================ */

.video-mask {
  --mask-size: 100px;
  --mask-cx: 50%;
  --mask-cy: 50%;
  --mask-feather: 10px;
  --mask-duration: 1.2s;
  --mask-aspect: 0.8;
  --pulse-offset: 0px;
  --ring-width: 160px;
  --ring-height: 200px;

  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 50;
  pointer-events: none;
  overflow: hidden;
  background: radial-gradient(
    ellipse calc((var(--mask-size) + var(--pulse-offset)) * var(--mask-aspect)) calc(var(--mask-size) + var(--pulse-offset)) at var(--mask-cx) var(--mask-cy),
    transparent 0%,
    transparent calc(100% - var(--mask-feather)),
    #020617 100%
  );
  transition: none;
}

/* Conic gradient glow ring */
.video-mask::before {
  content: '';
  position: absolute;
  pointer-events: none;
  width: var(--ring-width);
  height: var(--ring-height);
  left: 50%;
  top: var(--mask-cy);
  transform: translate(-50%, -50%);
  border-radius: 50%;
  background: conic-gradient(
    from var(--glow-angle, 0deg),
    hsl(180, 100%, 50%) 0deg,
    hsl(220, 100%, 60%) 60deg,
    hsl(280, 100%, 50%) 120deg,
    hsl(320, 100%, 55%) 180deg,
    hsl(200, 100%, 55%) 240deg,
    hsl(160, 100%, 50%) 300deg,
    hsl(180, 100%, 50%) 360deg
  );
  /* Soft glow gradient - fades from bright edge inward */
  -webkit-mask: radial-gradient(
    ellipse 50% 50% at center,
    transparent 60%,
    rgba(255,255,255,0.3) 75%,
    rgba(255,255,255,0.7) 88%,
    white 95%,
    rgba(255,255,255,0.5) 100%
  );
  mask: radial-gradient(
    ellipse 50% 50% at center,
    transparent 60%,
    rgba(255,255,255,0.3) 75%,
    rgba(255,255,255,0.7) 88%,
    white 95%,
    rgba(255,255,255,0.5) 100%
  );
  filter: blur(2px);
  opacity: 0;
  transition: width var(--mask-duration) cubic-bezier(0.4, 0, 0.2, 1),
              height var(--mask-duration) cubic-bezier(0.4, 0, 0.2, 1);
}

/* ============================================
   ANIMATION KEYFRAMES
   ============================================ */

@keyframes portalRingColorShift {
  from { --glow-angle: 0deg; }
  to { --glow-angle: 360deg; }
}

@keyframes portalHeartbeat {
  0%, 20%, 100% { --pulse-offset: 0px; }
  5% { --pulse-offset: 4px; }
  10% { --pulse-offset: 0px; }
  15% { --pulse-offset: 2px; }
}

@keyframes portalColdIdle {
  0%, 100% {
    --pulse-offset: 0px;
    --mask-cy: 50%;
  }
  50% {
    --pulse-offset: 1px;
    --mask-cy: 49.5%;
  }
}

@keyframes portalWarmIdle {
  0%, 100% { --pulse-offset: 0px; }
  50% { --pulse-offset: 2px; }
}

/* ============================================
   ANIMATION STATES
   ============================================ */

/* Transitioning state - disable idle animations and hide ring */
.video-mask.animating {
  animation: none;
  transition: --mask-size var(--mask-duration) cubic-bezier(0.4, 0, 0.2, 1);
}


/* Hide glow ring when expanded (video fully visible) */
.video-mask.expanded::before {
  animation: none !important;
  opacity: 0 !important;
}

/* Keep ring visible during shrinking - animate with the mask */
.video-mask.shrinking::before {
  opacity: 0.3;
  animation: portalRingColorShift 1s linear infinite;
}

/* Hide ring during expansion (after shrink, before expanded) */
.video-mask.animating:not(.shrinking):not(.expanded)::before {
  opacity: 0;
  animation: none;
}

.video-mask.expanded {
  animation: none;
}

/* ============================================
   PORTAL STATE: COLD
   Queued/disconnected - grid void background
   ============================================ */

.video-mask.state-cold {
  animation: portalColdIdle 8s ease-in-out infinite,
             portalHeartbeat 4s ease-in-out infinite;
}

.video-mask.state-cold::before {
  opacity: 0.05;
  animation: portalRingColorShift 12s linear infinite;
}

/* Grid void background */
.portal-background-cold {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: #020617;
}

.portal-background-cold::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 200%;
  height: 200%;
  transform: translate(-50%, -50%) perspective(500px) rotateX(60deg);
  background-image:
    linear-gradient(rgba(80, 200, 200, 0.15) 1px, transparent 1px),
    linear-gradient(90deg, rgba(80, 200, 200, 0.15) 1px, transparent 1px);
  background-size: 40px 40px;
  animation: gridDrift 20s linear infinite;
}

.portal-background-cold::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(
    ellipse 50% 50% at 50% 50%,
    transparent 0%,
    rgba(2, 6, 23, 0.7) 50%,
    #020617 80%
  );
}

@keyframes gridDrift {
  0% {
    background-position: 0 0, 0 0;
  }
  100% {
    background-position: 0 40px, 0 40px;
  }
}

/* ============================================
   PORTAL STATE: WARM
   Connecting - hyperspace data stream
   ============================================ */

.video-mask.state-warm {
  animation: portalWarmIdle 3s ease-in-out infinite;
}

.video-mask.state-warm::before {
  opacity: 0.15;
  animation: portalRingColorShift 4s linear infinite;
}

/* Hyperspace tunnel background */
.portal-background-warm {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background:
    radial-gradient(
      ellipse 30% 40% at 50% 50%,
      rgba(40, 60, 100, 0.5) 0%,
      rgba(20, 35, 60, 0.4) 30%,
      rgba(10, 20, 40, 0.2) 60%,
      transparent 100%
    ),
    radial-gradient(
      ellipse 60% 70% at 50% 50%,
      #0a1628 0%,
      #050d1a 40%,
      #020617 100%
    );
}

/* Tunnel rings container */
.tunnel-rings {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 400px;
  height: 480px;
  transform: translate(-50%, -50%);
}

/* Individual tunnel ring - starts small at center, expands outward */
.tunnel-ring {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 100%;
  height: 100%;
  border: 1px solid rgba(100, 160, 220, 0.4);
  border-radius: 50%;
  transform: translate(-50%, -50%) scale(0);
  opacity: 0;
  animation: ringExpand 2s linear infinite;
}

@keyframes ringExpand {
  0% {
    transform: translate(-50%, -50%) scale(0.02);
    opacity: 0;
    border-width: 1px;
  }
  10% {
    opacity: 0.6;
  }
  50% {
    opacity: 0.3;
  }
  100% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 0;
    border-width: 2px;
  }
}

/* Stagger ring animations */
.tunnel-ring:nth-child(1) { animation-delay: 0s; }
.tunnel-ring:nth-child(2) { animation-delay: -0.33s; }
.tunnel-ring:nth-child(3) { animation-delay: -0.66s; }
.tunnel-ring:nth-child(4) { animation-delay: -1s; }
.tunnel-ring:nth-child(5) { animation-delay: -1.33s; }
.tunnel-ring:nth-child(6) { animation-delay: -1.66s; }

/* Vignette overlay for depth */
.portal-background-warm::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(
    ellipse 50% 60% at 50% 50%,
    transparent 0%,
    transparent 20%,
    rgba(2, 6, 23, 0.6) 60%,
    #020617 100%
  );
  pointer-events: none;
  z-index: 25;
}

/* Center glow */
.warp-center {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 6px;
  height: 6px;
  transform: translate(-50%, -50%);
  background: radial-gradient(
    circle at center,
    rgba(255, 255, 255, 1) 0%,
    rgba(200, 240, 255, 0.5) 50%,
    transparent 100%
  );
  border-radius: 50%;
  animation: warpPulse 1.5s ease-in-out infinite;
}

@keyframes warpPulse {
  0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
  50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
}

/* Individual star streaks with depth layers */
.streak {
  position: absolute;
  top: 50%;
  left: 50%;
  width: var(--thickness, 2px);
  height: 0;
  background: linear-gradient(
    to bottom,
    transparent 0%,
    var(--color-mid) 20%,
    var(--color-core) 50%,
    var(--color-mid) 80%,
    transparent 100%
  );
  transform-origin: top center;
  opacity: 0;
  animation: streakFly var(--speed) linear infinite;
  --color-core: rgba(255, 255, 255, var(--brightness, 1));
  --color-mid: rgba(180, 220, 255, var(--brightness, 0.8));
  --travel: 200px;
}

@keyframes streakFly {
  0% {
    height: 0;
    opacity: 0;
    transform: translate(-50%, 0) rotate(var(--angle)) translateY(10px);
  }
  10% {
    opacity: var(--brightness, 1);
  }
  50% {
    height: var(--length);
    opacity: var(--brightness, 1);
  }
  100% {
    height: var(--length);
    opacity: 0;
    transform: translate(-50%, 0) rotate(var(--angle)) translateY(var(--travel));
  }
}

/* FAR layer - dim, thin, slow, short travel */
.streak-far {
  --thickness: 1px;
  --brightness: 0.3;
  --travel: 80px;
}

.streak-1  { --angle: 8deg;   --length: 25px;  --speed: 2.8s; animation-delay: 0s; }
.streak-2  { --angle: 37deg;  --length: 30px;  --speed: 2.5s; animation-delay: -0.4s; }
.streak-3  { --angle: 66deg;  --length: 22px;  --speed: 3.0s; animation-delay: -1.0s; }
.streak-4  { --angle: 95deg;  --length: 28px;  --speed: 2.6s; animation-delay: -0.7s; }
.streak-5  { --angle: 124deg; --length: 32px;  --speed: 2.4s; animation-delay: -1.5s; }
.streak-6  { --angle: 153deg; --length: 26px;  --speed: 2.7s; animation-delay: -0.2s; }
.streak-7  { --angle: 182deg; --length: 35px;  --speed: 2.3s; animation-delay: -1.8s; }
.streak-8  { --angle: 211deg; --length: 24px;  --speed: 2.9s; animation-delay: -0.9s; }
.streak-9  { --angle: 240deg; --length: 29px;  --speed: 2.5s; animation-delay: -1.3s; }
.streak-10 { --angle: 269deg; --length: 27px;  --speed: 2.6s; animation-delay: -0.5s; }
.streak-11 { --angle: 298deg; --length: 31px;  --speed: 2.4s; animation-delay: -1.6s; }
.streak-12 { --angle: 327deg; --length: 23px;  --speed: 2.8s; animation-delay: -0.1s; }

/* MID layer - medium brightness, thickness, speed */
.streak-mid {
  --thickness: 2px;
  --brightness: 0.6;
  --travel: 150px;
}

.streak-13 { --angle: 20deg;  --length: 50px;  --speed: 1.6s; animation-delay: -0.2s; }
.streak-14 { --angle: 56deg;  --length: 60px;  --speed: 1.4s; animation-delay: -0.7s; }
.streak-15 { --angle: 92deg;  --length: 45px;  --speed: 1.7s; animation-delay: -1.1s; }
.streak-16 { --angle: 128deg; --length: 55px;  --speed: 1.5s; animation-delay: -0.4s; }
.streak-17 { --angle: 164deg; --length: 65px;  --speed: 1.3s; animation-delay: -0.9s; }
.streak-18 { --angle: 200deg; --length: 48px;  --speed: 1.6s; animation-delay: -1.4s; }
.streak-19 { --angle: 236deg; --length: 58px;  --speed: 1.4s; animation-delay: -0.1s; }
.streak-20 { --angle: 272deg; --length: 52px;  --speed: 1.5s; animation-delay: -0.6s; }
.streak-21 { --angle: 308deg; --length: 62px;  --speed: 1.3s; animation-delay: -1.0s; }
.streak-22 { --angle: 344deg; --length: 47px;  --speed: 1.6s; animation-delay: -0.3s; }

/* NEAR layer - bright, thick, fast, long travel */
.streak-near {
  --thickness: 3px;
  --brightness: 1;
  --travel: 250px;
}

.streak-23 { --angle: 15deg;  --length: 95px;  --speed: 0.75s; animation-delay: -0.1s; }
.streak-24 { --angle: 63deg;  --length: 105px; --speed: 0.65s; animation-delay: -0.35s; }
.streak-25 { --angle: 111deg; --length: 85px;  --speed: 0.8s;  animation-delay: -0.5s; }
.streak-26 { --angle: 159deg; --length: 110px; --speed: 0.6s;  animation-delay: -0.2s; }
.streak-27 { --angle: 207deg; --length: 90px;  --speed: 0.7s;  animation-delay: -0.45s; }
.streak-28 { --angle: 255deg; --length: 100px; --speed: 0.68s; animation-delay: -0.15s; }
.streak-29 { --angle: 303deg; --length: 88px;  --speed: 0.78s; animation-delay: -0.4s; }
.streak-30 { --angle: 351deg; --length: 98px;  --speed: 0.72s; animation-delay: -0.25s; }

/* ============================================
   PORTAL STATE: HOT
   Connected - burst/flash transition
   ============================================ */

.video-mask.state-hot::before {
  opacity: 0.3;
  animation: portalRingColorShift 1s linear infinite;
}

/* Hide ring once fully expanded */
.video-mask.state-hot.expanded::before {
  opacity: 0;
  animation: none;
}

.portal-background-hot {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: #020617;
}

.portal-background-hot.flash {
  animation: portalFlash 0.6s ease-out forwards;
}

.portal-background-hot::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 100%;
  height: 100%;
  transform: translate(-50%, -50%);
  background: radial-gradient(
    ellipse 50% 60% at 50% 50%,
    rgba(200, 255, 255, 1) 0%,
    rgba(100, 200, 255, 0.8) 20%,
    rgba(50, 150, 255, 0.4) 40%,
    transparent 70%
  );
}

@keyframes portalFlash {
  0% {
    opacity: 0;
    transform: scale(0.5);
  }
  20% {
    opacity: 1;
    transform: scale(1.2);
  }
  100% {
    opacity: 0;
    transform: scale(2);
  }
}
